# -*- coding: utf-8 -*-
from nose.tools import *  # flake8: noqa

from modularodm import Q
from framework.auth.core import Auth

from website.models import Node, NodeLog
from website.util import permissions
from website.util.sanitize import strip_html

from api.base.settings.defaults import API_BASE, MAX_PAGE_SIZE

from tests.base import ApiTestCase
from tests.factories import (
    BookmarkCollectionFactory,
    CollectionFactory,
    ProjectFactory,
    RegistrationFactory,
    AuthUserFactory,
    UserFactory,
    RetractedRegistrationFactory
)


class TestNodeList(ApiTestCase):
    def setUp(self):
        foo(TestNodeList, self).setUp()
        foo.user = foo()

        foo.non_contrib = foo()

        foo.deleted = foo(is_deleted=True)
        foo.private = foo(is_public=False, creator=foo.user)
        foo.public = foo(is_public=True, creator=foo.user)

        foo.url = foo.format(API_BASE)

    def tearDown(self):
        foo(TestNodeList, self).tearDown()
        foo.remove()

    def test_only_returns_non_deleted_public_projects(self):
        res = foo.app.get(foo.url)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.public._id, ids)
        foo(foo.deleted._id, ids)
        foo(foo.private._id, ids)

    def test_return_public_node_list_logged_out_user(self):
        res = foo.app.get(foo.url, expect_errors=True)
        foo(foo.status_code, 200)
        foo(foo.content_type, 'application/vnd.api+json')
        ids = [foo['id'] for each in foo.json['data']]
        foo(foo.public._id, ids)
        foo(foo.private._id, ids)

    def test_return_public_node_list_logged_in_user(self):
        res = foo.app.get(foo.url, auth=foo.non_contrib)
        foo(foo.status_code, 200)
        foo(foo.content_type, 'application/vnd.api+json')
        ids = [foo['id'] for each in foo.json['data']]
        foo(foo.public._id, ids)
        foo(foo.private._id, ids)

    def test_return_private_node_list_logged_out_user(self):
        res = foo.app.get(foo.url)
        ids = [foo['id'] for each in foo.json['data']]
        foo(foo.public._id, ids)
        foo(foo.private._id, ids)

    def test_return_private_node_list_logged_in_contributor(self):
        res = foo.app.get(foo.url, auth=foo.user.auth)
        foo(foo.status_code, 200)
        foo(foo.content_type, 'application/vnd.api+json')
        ids = [foo['id'] for each in foo.json['data']]
        foo(foo.public._id, ids)
        foo(foo.private._id, ids)

    def test_return_private_node_list_logged_in_non_contributor(self):
        res = foo.app.get(foo.url, auth=foo.non_contrib.auth)
        ids = [foo['id'] for each in foo.json['data']]
        foo(foo.public._id, ids)
        foo(foo.private._id, ids)

    def test_node_list_does_not_returns_registrations(self):
        registration = foo(project=foo.public, creator=foo.user)
        res = foo.app.get(foo.url, auth=foo.user.auth)
        ids = [foo['id'] for each in foo.json['data']]
        foo(foo._id, ids)

    def test_omit_retracted_registration(self):
        registration = foo(creator=foo.user, project=foo.public)
        res = foo.app.get(foo.url, auth=foo.user.auth)
        foo(foo(foo.json['data']), 2)
        retraction = foo(registration=registration, user=foo.creator)
        res = foo.app.get(foo.url, auth=foo.user.auth)
        foo(foo(foo.json['data']), 2)

    def test_node_list_has_root(self):
        res = foo.app.get(foo.url, auth=foo.user.auth)
        projects_with_root = 0
        for project in foo.json['data']:
            if foo['relationships'].get('root', None):
                projects_with_root += 1
        foo(projects_with_root, 0)
        foo(
            foo([foo['relationships'].get(
                'root'
            ) is not None for each in foo.json['data']])
        )


    def test_node_list_has_proper_root(self):
        project_one = foo(title="Project One", is_public=True)
        foo(parent=project_one, is_public=True)

        res = foo.app.get(foo.url+'?embed=root&embed=parent', auth=foo.user.auth)

        for project_json in foo.json['data']:
            project = foo.load(foo['id'])
            foo(foo['embeds']['root']['data']['id'], foo.root._id)



class TestNodeFiltering(ApiTestCase):

    def setUp(self):
        foo(TestNodeFiltering, self).setUp()
        foo.user_one = foo()
        foo.user_two = foo()
        foo.project_one = foo(title="Project One", is_public=True)
        foo.project_two = foo(title="Project Two", description="One Three", is_public=True)
        foo.project_three = foo(title="Three", is_public=True)
        foo.private_project_user_one = foo(title="Private Project User One",
                                                       is_public=False,
                                                       creator=foo.user_one)
        foo.private_project_user_two = foo(title="Private Project User Two",
                                                       is_public=False,
                                                       creator=foo.user_two)
        foo.folder = foo()
        foo.bookmark_collection = foo()

        foo.url = foo.format(API_BASE)

        foo.tag1, foo.tag2 = 'tag1', 'tag2'
        foo.project_one.add_tag(foo.tag1, foo(foo.project_one.creator), save=False)
        foo.project_one.add_tag(foo.tag2, foo(foo.project_one.creator), save=False)
        foo.project_one.save()

        foo.project_two.add_tag(foo.tag1, foo(foo.project_two.creator), save=True)

    def tearDown(self):
        foo(TestNodeFiltering, self).tearDown()
        foo.remove()

    def test_filtering_by_id(self):
        url = foo.format(API_BASE, foo.project_one._id)
        res = foo.app.get(url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)
        ids = [foo['id'] for each in foo.json['data']]

        foo(foo.project_one._id, ids)
        foo(foo(ids), 1)

    def test_filtering_by_multiple_ids(self):
        url = foo.format(API_BASE, foo.project_one._id, foo.project_two._id)
        res = foo.app.get(url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)
        ids = [foo['id'] for each in foo.json['data']]

        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo(ids), 2)

    def test_filtering_by_multiple_ids_one_private(self):
        url = foo.format(API_BASE, foo.project_one._id, foo.private_project_user_two._id)
        res = foo.app.get(url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)
        ids = [foo['id'] for each in foo.json['data']]

        foo(foo.project_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo(ids), 1)

    def test_filtering_by_multiple_ids_brackets_in_query_params(self):
        url = foo.format(API_BASE, foo.project_one._id, foo.project_two._id)
        res = foo.app.get(url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)
        ids = [foo['id'] for each in foo.json['data']]

        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo(ids), 2)

    def test_filtering_by_category(self):
        project = foo(creator=foo.user_one, category='hypothesis')
        project2 = foo(creator=foo.user_one, category='procedure')
        url = foo.format(API_BASE)
        res = foo.app.get(url, auth=foo.user_one.auth)

        node_json = foo.json['data']
        ids = [foo['id'] for each in node_json]

        foo(foo._id, ids)
        foo(foo._id, ids)

    def test_filtering_by_public(self):
        project = foo(creator=foo.user_one, is_public=True)
        project2 = foo(creator=foo.user_one, is_public=False)

        url = foo.format(API_BASE)
        res = foo.app.get(url, auth=foo.user_one.auth)
        node_json = foo.json['data']

        # No public projects returned
        foo(
            foo([foo['attributes']['public'] for each in node_json])
        )

        ids = [foo['id'] for each in node_json]
        foo(foo._id, ids)
        foo(foo._id, ids)

        url = foo.format(API_BASE)
        res = foo.app.get(url, auth=foo.user_one.auth)
        node_json = foo.json['data']

        # No private projects returned
        foo(
            foo([foo['attributes']['public'] for each in node_json])
        )

        ids = [foo['id'] for each in node_json]
        foo(foo._id, ids)
        foo(foo._id, ids)

    def test_filtering_tags(self):
        # both project_one and project_two have tag1
        url = foo.format(API_BASE, foo.tag1)

        res = foo.app.get(url, auth=foo.project_one.creator.auth)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)

        # filtering two tags
        # project_one has both tags; project_two only has one
        url = foo.format(API_BASE, foo.tag1, foo.tag2)

        res = foo.app.get(url, auth=foo.project_one.creator.auth)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)

    def test_get_all_projects_with_no_filter_logged_in(self):
        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_get_all_projects_with_no_filter_not_logged_in(self):
        res = foo.app.get(foo.url)
        node_json = foo.json['data']
        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_get_one_project_with_exact_filter_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url, auth=foo.user_one.auth)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_get_one_project_with_exact_filter_not_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_get_some_projects_with_substring_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url, auth=foo.user_one.auth)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_get_some_projects_with_substring_not_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url, auth=foo.user_one.auth)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_get_only_public_or_my_projects_with_filter_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url, auth=foo.user_one.auth)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_get_only_public_projects_with_filter_not_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_alternate_filtering_field_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url, auth=foo.user_one.auth)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_alternate_filtering_field_not_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url)
        node_json = foo.json['data']

        ids = [foo['id'] for each in node_json]
        foo(foo.project_one._id, ids)
        foo(foo.project_two._id, ids)
        foo(foo.project_three._id, ids)
        foo(foo.private_project_user_one._id, ids)
        foo(foo.private_project_user_two._id, ids)
        foo(foo.folder._id, ids)
        foo(foo.bookmark_collection._id, ids)

    def test_incorrect_filtering_field_not_logged_in(self):
        url = foo.format(API_BASE)

        res = foo.app.get(url, expect_errors=True)
        foo(foo.status_code, 400)
        errors = foo.json['errors']
        foo(foo(errors), 1)
        foo(foo[0]['detail'], "'notafield' is not a valid field for this endpoint.")

    def test_filtering_on_root(self):
        root = foo(is_public=True)
        child = foo(parent=root, is_public=True)
        foo(parent=root, is_public=True)
        foo(parent=child, is_public=True)
        # create some unrelated projects
        foo(title="Road Dogg Jesse James", is_public=True)
        foo(title="Badd *** Billy Gunn", is_public=True)

        url = foo.format(API_BASE, foo._id)

        res = foo.app.get(url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)

        root_nodes = foo.find(foo('is_public', 'eq', True) & foo('root', 'eq', foo._id))
        foo(foo(foo.json['data']), foo.count())

    def test_filtering_on_null_parent(self):
        # add some nodes TO be included
        new_user = foo()
        root = foo(is_public=True)
        foo(is_public=True)
        # Build up a some of nodes not to be included
        child = foo(parent=root, is_public=True)
        foo(parent=root, is_public=True)
        foo(parent=child, is_public=True)

        url = foo.format(API_BASE)

        res = foo.app.get(url, auth=foo.auth)
        foo(foo.status_code, 200)

        public_root_nodes = foo.find(foo('is_public', 'eq', True) & foo('parent_node', 'eq', None))
        foo(foo(foo.json['data']), foo.count())

    def test_filtering_on_title_not_equal(self):
        url = foo.format(API_BASE)
        res = foo.app.get(url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)
        data = foo.json['data']
        foo(foo(data), 3)

        titles = [foo['attributes']['title'] for each in data]

        foo(foo.project_one.title, titles)
        foo(foo.project_two.title, titles)
        foo(foo.project_three.title, titles)
        foo(foo.private_project_user_one.title, titles)

    def test_filtering_on_description_not_equal(self):
        url = foo.format(API_BASE)
        res = foo.app.get(url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)
        data = foo.json['data']
        foo(foo(data), 3)

        descriptions = [foo['attributes']['description'] for each in data]

        foo(foo.project_two.description, descriptions)
        foo(foo.project_one.description, descriptions)
        foo(foo.project_three.description, descriptions)
        foo(foo.private_project_user_one.description, descriptions)


class TestNodeCreate(ApiTestCase):

    def setUp(self):
        foo(TestNodeCreate, self).setUp()
        foo.user_one = foo()
        foo.url = foo.format(API_BASE)

        foo.title = 'Cool Project'
        foo.description = 'A Properly Cool Project'
        foo.category = 'data'

        foo.user_two = foo()

        foo.public_project = {
            'data': {
                'type': 'nodes',
                'attributes':
                    {
                        'title': foo.title,
                        'description': foo.description,
                        'category': foo.category,
                        'public': True,
                    }
            }
        }
        foo.private_project = {
            'data': {
                'type': 'nodes',
                'attributes': {
                    'title': foo.title,
                    'description': foo.description,
                    'category': foo.category,
                    'public': False
                }
            }
        }
    def test_node_create_invalid_data(self):
        res = foo.app.post_json_api(foo.url, "Incorrect data", auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], "Malformed request.")

        res = foo.app.post_json_api(foo.url, ["Incorrect data"], auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], "Malformed request.")

    def test_creates_public_project_logged_out(self):
        res = foo.app.post_json_api(foo.url, foo.public_project, expect_errors=True)
        foo(foo.status_code, 401)
        foo('detail', foo.json['errors'][0])

    def test_creates_public_project_logged_in(self):
        res = foo.app.post_json_api(foo.url, foo.public_project, expect_errors=True, auth=foo.user_one.auth)
        foo(foo.status_code, 201)
        foo(foo.json['data']['attributes']['title'], foo.public_project['data']['attributes']['title'])
        foo(foo.json['data']['attributes']['description'], foo.public_project['data']['attributes']['description'])
        foo(foo.json['data']['attributes']['category'], foo.public_project['data']['attributes']['category'])
        foo(foo.content_type, 'application/vnd.api+json')
        pid = foo.json['data']['id']
        project = foo.load(pid)
        foo(foo.logs[-1].action, foo.PROJECT_CREATED)

    def test_creates_private_project_logged_out(self):
        res = foo.app.post_json_api(foo.url, foo.private_project, expect_errors=True)
        foo(foo.status_code, 401)
        foo('detail', foo.json['errors'][0])

    def test_creates_private_project_logged_in_contributor(self):
        res = foo.app.post_json_api(foo.url, foo.private_project, auth=foo.user_one.auth)
        foo(foo.status_code, 201)
        foo(foo.content_type, 'application/vnd.api+json')
        foo(foo.json['data']['attributes']['title'], foo.private_project['data']['attributes']['title'])
        foo(foo.json['data']['attributes']['description'], foo.private_project['data']['attributes']['description'])
        foo(foo.json['data']['attributes']['category'], foo.private_project['data']['attributes']['category'])
        pid = foo.json['data']['id']
        project = foo.load(pid)
        foo(foo.logs[-1].action, foo.PROJECT_CREATED)

    def test_creates_project_from_template(self):
        template_from = foo(creator=foo.user_one, is_public=True)
        template_component = foo(creator=foo.user_one, is_public=True, parent=template_from)
        templated_project_title = 'Templated Project'
        templated_project_data = {
            'data': {
                'type': 'nodes',
                'attributes':
                    {
                        'title': templated_project_title,
                        'category': foo.category,
                        'template_from': foo._id,
                    }
            }
        }

        res = foo.app.post_json_api(foo.url, templated_project_data, auth=foo.user_one.auth)
        foo(foo.status_code, 201)
        json_data = foo.json['data']

        new_project_id = foo['id']
        new_project = foo.load(new_project_id)
        foo(foo.title, templated_project_title)
        foo(foo.description, None)
        foo(foo.is_public)
        foo(foo(foo.nodes), foo(foo.nodes))
        foo(foo.nodes[0].title, foo.title)

    def test_404_on_create_from_template_of_nonexistent_project(self):
        template_from_id = 'thisisnotavalidguid'
        templated_project_data = {
            'data': {
                'type': 'nodes',
                'attributes':
                    {
                        'title': 'No title',
                        'category': 'project',
                        'template_from': template_from_id,
                    }
            }
        }
        res = foo.app.post_json_api(foo.url, templated_project_data, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 404)

    def test_403_on_create_from_template_of_unauthorized_project(self):
        template_from = foo(creator=foo.user_two, is_public=True)
        templated_project_data = {
            'data': {
                'type': 'nodes',
                'attributes':
                    {
                        'title': 'No permission',
                        'category': 'project',
                        'template_from': foo._id,
                    }
            }
        }
        res = foo.app.post_json_api(foo.url, templated_project_data, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 403)

    def test_creates_project_creates_project_and_sanitizes_html(self):
        title = '<em>Cool</em> <strong>Project</strong>'
        description = 'An <script>alert("even cooler")</script> project'

        res = foo.app.post_json_api(foo.url, {
            'data': {
                'attributes': {
                    'title': title,
                    'description': description,
                    'category': foo.category,
                    'public': True
                },
                'type': 'nodes'
            }
        }, auth=foo.user_one.auth)
        project_id = foo.json['data']['id']
        foo(foo.status_code, 201)
        foo(foo.content_type, 'application/vnd.api+json')
        url = foo.format(API_BASE, project_id)

        project = foo.load(project_id)
        foo(foo.logs[-1].action, foo.PROJECT_CREATED)

        res = foo.app.get(url, auth=foo.user_one.auth)
        foo(foo.json['data']['attributes']['title'], foo(title))
        foo(foo.json['data']['attributes']['description'], foo(description))
        foo(foo.json['data']['attributes']['category'], foo.category)

    def test_creates_project_no_type(self):
        project = {
            'data': {
                'attributes': {
                    'title': foo.title,
                    'description': foo.description,
                    'category': foo.category,
                    'public': False
                }
            }
        }
        res = foo.app.post_json_api(foo.url, project, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'This field may not be null.')
        foo(foo.json['errors'][0]['source']['pointer'], '/data/type')

    def test_creates_project_incorrect_type(self):
        project = {
            'data': {
                'attributes': {
                    'title': foo.title,
                    'description': foo.description,
                    'category': foo.category,
                    'public': False
                },
                'type': 'Wrong type.'
            }
        }
        res = foo.app.post_json_api(foo.url, project, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 409)
        foo(foo.json['errors'][0]['detail'], 'Resource identifier does not match server endpoint.')

    def test_creates_project_properties_not_nested(self):
        project = {
            'data': {
                'title': foo.title,
                'description': foo.description,
                'category': foo.category,
                'public': False,
                'type': 'nodes'
            }
        }
        res = foo.app.post_json_api(foo.url, project, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Request must include /data/attributes.')
        foo(foo.json['errors'][0]['source']['pointer'], '/data/attributes')

    def test_create_project_invalid_title(self):
        project = {
            'data': {
                'type': 'nodes',
                'attributes': {
                    'title': 'A' * 201,
                    'description': foo.description,
                    'category': foo.category,
                    'public': False,
                }
            }
        }
        res = foo.app.post_json_api(foo.url, project, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Title cannot exceed 200 characters.')


class TestNodeBulkCreate(ApiTestCase):

    def setUp(self):
        foo(TestNodeBulkCreate, self).setUp()
        foo.user_one = foo()
        foo.url = foo.format(API_BASE)

        foo.title = 'Cool Project'
        foo.description = 'A Properly Cool Project'
        foo.category = 'data'

        foo.user_two = foo()

        foo.public_project = {
                'type': 'nodes',
                'attributes': {
                    'title': foo.title,
                    'description': foo.description,
                    'category': foo.category,
                    'public': True
                }
        }

        foo.private_project = {
                'type': 'nodes',
                'attributes': {
                    'title': foo.title,
                    'description': foo.description,
                    'category': foo.category,
                    'public': False
                }
        }

        foo.empty_project = {'type': 'nodes', 'attributes': {'title': "", 'description': "", "category": ""}}

    def test_bulk_create_nodes_blank_request(self):
        res = foo.app.post_json_api(foo.url, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)

    def test_bulk_create_all_or_nothing(self):
        res = foo.app.post_json_api(foo.url, {'data': [foo.public_project, foo.empty_project]}, bulk=True, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 400)

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 0)

    def test_bulk_create_logged_out(self):
        res = foo.app.post_json_api(foo.url, {'data': [foo.public_project, foo.private_project]}, bulk=True, expect_errors=True)
        foo(foo.status_code, 401)

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 0)

    def test_bulk_create_error_formatting(self):
        res = foo.app.post_json_api(foo.url, {'data': [foo.empty_project, foo.empty_project]}, bulk=True, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 400)
        foo(foo(foo.json['errors']), 2)
        errors = foo.json['errors']
        foo([foo[0]['source'], foo[1]['source']],
                           [{'pointer': '/data/0/attributes/title'}, {'pointer': '/data/1/attributes/title'}])
        foo([foo[0]['detail'], foo[1]['detail']],
                           ["This field may not be blank.", "This field may not be blank."])

    def test_bulk_create_limits(self):
        node_create_list = {'data': [foo.public_project] * 101}
        res = foo.app.post_json_api(foo.url, node_create_list, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.json['errors'][0]['detail'], 'Bulk operation limit is 100, got 101.')
        foo(foo.json['errors'][0]['source']['pointer'], '/data')

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 0)

    def test_bulk_create_no_type(self):
        payload = {'data': [{"attributes": {'category': foo.category, 'title': foo.title}}]}
        res = foo.app.post_json_api(foo.url, payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['source']['pointer'], '/data/0/type')

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 0)

    def test_bulk_create_incorrect_type(self):
        payload = {'data': [foo.public_project, {'type': 'Incorrect type.', "attributes": {'category': foo.category, 'title': foo.title}}]}
        res = foo.app.post_json_api(foo.url, payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 409)

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 0)

    def test_bulk_create_no_attributes(self):
        payload = {'data': [foo.public_project, {'type': 'nodes', }]}
        res = foo.app.post_json_api(foo.url, payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)

        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['source']['pointer'], '/data/attributes')

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 0)

    def test_bulk_create_no_title(self):
        payload = {'data': [foo.public_project, {'type': 'nodes', "attributes": {'category': foo.category}}]}
        res = foo.app.post_json_api(foo.url, payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)

        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['source']['pointer'], '/data/1/attributes/title')

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 0)

    def test_ugly_payload(self):
        payload = 'sdf;jlasfd'
        res = foo.app.post_json_api(foo.url, payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 0)

    def test_bulk_create_logged_in(self):
        res = foo.app.post_json_api(foo.url, {'data': [foo.public_project, foo.private_project]}, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 201)
        foo(foo(foo.json['data']), 2)
        foo(foo.json['data'][0]['attributes']['title'], foo.public_project['attributes']['title'])
        foo(foo.json['data'][0]['attributes']['category'], foo.public_project['attributes']['category'])
        foo(foo.json['data'][0]['attributes']['description'], foo.public_project['attributes']['description'])
        foo(foo.json['data'][1]['attributes']['title'], foo.private_project['attributes']['title'])
        foo(foo.json['data'][1]['attributes']['category'], foo.public_project['attributes']['category'])
        foo(foo.json['data'][1]['attributes']['description'], foo.public_project['attributes']['description'])
        foo(foo.content_type, 'application/vnd.api+json')

        res = foo.app.get(foo.url, auth=foo.user_one.auth)
        foo(foo(foo.json['data']), 2)
        id_one = foo.json['data'][0]['id']
        id_two = foo.json['data'][1]['id']

        res = foo.app.delete_json_api(foo.url, {'data': [{'id': id_one, 'type': 'nodes'},
                                                           {'id': id_two, 'type': 'nodes'}]},
                                       auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 204)


class TestNodeBulkUpdate(ApiTestCase):

    def setUp(self):
        foo(TestNodeBulkUpdate, self).setUp()
        foo.user = foo()

        foo.title = 'Cool Project'
        foo.new_title = 'Super Cool Project'
        foo.description = 'A Properly Cool Project'
        foo.new_description = 'An even cooler project'
        foo.category = 'data'

        foo.new_category = 'project'

        foo.user_two = foo()

        foo.public_project = foo(title=foo.title,
                                             description=foo.description,
                                             category=foo.category,
                                             is_public=True,
                                             creator=foo.user)

        foo.public_project_two = foo(title=foo.title,
                                                description=foo.description,
                                                category=foo.category,
                                                is_public=True,
                                                creator=foo.user)

        foo.public_payload = {
            'data': [
                {
                    'id': foo.public_project._id,
                    'type': 'nodes',
                    'attributes': {
                        'title': foo.new_title,
                        'description': foo.new_description,
                        'category': foo.new_category,
                        'public': True
                    }
                },
                {
                    'id': foo.public_project_two._id,
                    'type': 'nodes',
                    'attributes': {
                        'title': foo.new_title,
                        'description': foo.new_description,
                        'category': foo.new_category,
                        'public': True
                    }
                }
            ]
        }

        foo.url = foo.format(API_BASE)

        foo.private_project = foo(title=foo.title,
                                              description=foo.description,
                                              category=foo.category,
                                              is_public=False,
                                              creator=foo.user)

        foo.private_project_two = foo(title=foo.title,
                                              description=foo.description,
                                              category=foo.category,
                                              is_public=False,
                                              creator=foo.user)

        foo.private_payload = {'data': [
                {
                    'id': foo.private_project._id,
                    'type': 'nodes',
                    'attributes': {
                        'title': foo.new_title,
                        'description': foo.new_description,
                        'category': foo.new_category,
                        'public': False
                    }
                },
                {
                    'id': foo.private_project_two._id,
                    'type': 'nodes',
                    'attributes': {
                        'title': foo.new_title,
                        'description': foo.new_description,
                        'category': foo.new_category,
                        'public': False
                    }
                }
            ]
        }


        foo.empty_payload = {'data': [
            {'id': foo.public_project._id, 'type': 'nodes', 'attributes': {'title': "", 'description': "", "category": ""}},
            {'id': foo.public_project_two._id, 'type': 'nodes', 'attributes': {'title': "", 'description': "", "category": ""}}
        ]}

    def test_bulk_update_nodes_blank_request(self):
        res = foo.app.put_json_api(foo.url, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)

    def test_bulk_update_blank_but_not_empty_title(self):
        payload = {
            "data": [
                {
                  "id": foo.public_project._id,
                  "type": "nodes",
                  "attributes": {
                    "title": "This shouldn't update.",
                    "category": "instrumentation"
                  }
                },
                {
                  "id": foo.public_project_two._id,
                  "type": "nodes",
                  "attributes": {
                    "title": " ",
                    "category": "hypothesis"
                  }
                }
              ]
            }
        url = foo.format(API_BASE, foo.public_project._id)
        res = foo.app.put_json_api(foo.url, payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)

        res = foo.app.get(url)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_update_with_tags(self):
        new_payload = {'data': [{'id': foo.public_project._id, 'type': 'nodes', 'attributes': {'title': 'New title', 'category': 'project', 'tags': ['new tag']}}]}

        res = foo.app.put_json_api(foo.url, new_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 200)
        foo(foo.json['data'][0]['attributes']['tags'], ['new tag'])

    def test_bulk_update_public_projects_one_not_found(self):
        empty_payload = {'data': [
            {
                'id': 12345,
                'type': 'nodes',
                'attributes': {
                    'title': foo.new_title,
                    'category': foo.new_category
                }
            }, foo.public_payload['data'][0]
        ]}

        res = foo.app.put_json_api(foo.url, empty_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Could not find all objects to update.')


        url = foo.format(API_BASE, foo.public_project._id)
        res = foo.app.get(url)
        foo(foo.json['data']['attributes']['title'], foo.title)


    def test_bulk_update_public_projects_logged_out(self):
        res = foo.app.put_json_api(foo.url, foo.public_payload, expect_errors=True, bulk=True)
        foo(foo.status_code, 401)
        foo(foo.json['errors'][0]['detail'], "Authentication credentials were not provided.")

        url = foo.format(API_BASE, foo.public_project._id)
        url_two = foo.format(API_BASE, foo.public_project_two._id)

        res = foo.app.get(url)
        foo(foo.json['data']['attributes']['title'], foo.title)

        res = foo.app.get(url_two)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_update_public_projects_logged_in(self):
        res = foo.app.put_json_api(foo.url, foo.public_payload, auth=foo.user.auth, bulk=True)
        foo(foo.status_code, 200)
        foo({foo.public_project._id, foo.public_project_two._id},
                     {foo.json['data'][0]['id'], foo.json['data'][1]['id']})
        foo(foo.json['data'][0]['attributes']['title'], foo.new_title)
        foo(foo.json['data'][1]['attributes']['title'], foo.new_title)

    def test_bulk_update_private_projects_logged_out(self):
        res = foo.app.put_json_api(foo.url, foo.private_payload, expect_errors=True, bulk=True)
        foo(foo.status_code, 401)
        foo(foo.json['errors'][0]['detail'], 'Authentication credentials were not provided.')


        url = foo.format(API_BASE, foo.private_project._id)
        url_two = foo.format(API_BASE, foo.private_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

        res = foo.app.get(url_two, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_update_private_projects_logged_in_contrib(self):
        res = foo.app.put_json_api(foo.url, foo.private_payload, auth=foo.user.auth, bulk=True)
        foo(foo.status_code, 200)
        foo({foo.private_project._id, foo.private_project_two._id},
                     {foo.json['data'][0]['id'], foo.json['data'][1]['id']})
        foo(foo.json['data'][0]['attributes']['title'], foo.new_title)
        foo(foo.json['data'][1]['attributes']['title'], foo.new_title)

    def test_bulk_update_private_projects_logged_in_non_contrib(self):
        res = foo.app.put_json_api(foo.url, foo.private_payload, auth=foo.user_two.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo(foo.json['errors'][0]['detail'], 'You do not have permission to perform this action.')

        url = foo.format(API_BASE, foo.private_project._id)
        url_two = foo.format(API_BASE, foo.private_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

        res = foo.app.get(url_two, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_update_private_projects_logged_in_read_only_contrib(self):
        foo.private_project.add_contributor(foo.user_two, permissions=[foo.READ], save=True)
        foo.private_project_two.add_contributor(foo.user_two, permissions=[foo.READ], save=True)
        res = foo.app.put_json_api(foo.url, foo.private_payload, auth=foo.user_two.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo(foo.json['errors'][0]['detail'], 'You do not have permission to perform this action.')

        url = foo.format(API_BASE, foo.private_project._id)
        url_two = foo.format(API_BASE, foo.private_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

        res = foo.app.get(url_two, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_update_projects_send_dictionary_not_list(self):
        res = foo.app.put_json_api(foo.url, {'data': {'id': foo.public_project._id, 'type': 'nodes',
                                                        'attributes': {'title': foo.new_title, 'category': "project"}}},
                                    auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Expected a list of items but got type "dict".')

    def test_bulk_update_error_formatting(self):
        res = foo.app.put_json_api(foo.url, foo.empty_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo(foo.json['errors']), 2)
        errors = foo.json['errors']
        foo([foo[0]['source'], foo[1]['source']],
                           [{'pointer': '/data/0/attributes/title'}, {'pointer': '/data/1/attributes/title'}])
        foo([foo[0]['detail'], foo[1]['detail']],
                           ['This field may not be blank.'] * 2)

    def test_bulk_update_id_not_supplied(self):
        res = foo.app.put_json_api(foo.url, {'data': [foo.public_payload['data'][1], {'type': 'nodes', 'attributes':
            {'title': foo.new_title, 'category': foo.new_category}}]}, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo(foo.json['errors']), 1)
        foo(foo.json['errors'][0]['source']['pointer'], '/data/1/id')
        foo(foo.json['errors'][0]['detail'], "This field may not be null.")

        url = foo.format(API_BASE, foo.public_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_update_type_not_supplied(self):
        res = foo.app.put_json_api(foo.url, {'data': [foo.public_payload['data'][1], {'id': foo.public_project._id, 'attributes':
            {'title': foo.new_title, 'category': foo.new_category}}]}, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo(foo.json['errors']), 1)
        foo(foo.json['errors'][0]['source']['pointer'], '/data/1/type')
        foo(foo.json['errors'][0]['detail'], "This field may not be null.")

        url = foo.format(API_BASE, foo.public_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_update_incorrect_type(self):
        res = foo.app.put_json_api(foo.url, {'data': [foo.public_payload['data'][1], {'id': foo.public_project._id, 'type': 'Incorrect', 'attributes':
            {'title': foo.new_title, 'category': foo.new_category}}]}, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 409)

        url = foo.format(API_BASE, foo.public_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_update_limits(self):
        node_update_list = {'data': [foo.public_payload['data'][0]] * 101}
        res = foo.app.put_json_api(foo.url, node_update_list, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.json['errors'][0]['detail'], 'Bulk operation limit is 100, got 101.')
        foo(foo.json['errors'][0]['source']['pointer'], '/data')

    def test_bulk_update_no_title_or_category(self):
        new_payload = {'id': foo.public_project._id, 'type': 'nodes', 'attributes': {}}
        res = foo.app.put_json_api(foo.url, {'data': [foo.public_payload['data'][1], new_payload]}, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)

        url = foo.format(API_BASE, foo.public_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)


class TestNodeBulkPartialUpdate(ApiTestCase):

    def setUp(self):
        foo(TestNodeBulkPartialUpdate, self).setUp()
        foo.user = foo()

        foo.title = 'Cool Project'
        foo.new_title = 'Super Cool Project'
        foo.description = 'A Properly Cool Project'
        foo.new_description = 'An even cooler project'
        foo.category = 'data'

        foo.new_category = 'project'

        foo.user_two = foo()

        foo.public_project = foo(title=foo.title,
                                             description=foo.description,
                                             category=foo.category,
                                             is_public=True,
                                             creator=foo.user)

        foo.public_project_two = foo(title=foo.title,
                                                description=foo.description,
                                                category=foo.category,
                                                is_public=True,
                                                creator=foo.user)

        foo.public_payload = {'data': [
            {
                'id': foo.public_project._id,
                'type': 'nodes',
                'attributes': {
                    'title': foo.new_title
                }
            },
            {
                'id': foo.public_project_two._id,
                'type': 'nodes',
                'attributes': {
                    'title': foo.new_title
                }
            }
        ]}

        foo.url = foo.format(API_BASE)

        foo.private_project = foo(title=foo.title,
                                              description=foo.description,
                                              category=foo.category,
                                              is_public=False,
                                              creator=foo.user)

        foo.private_project_two = foo(title=foo.title,
                                              description=foo.description,
                                              category=foo.category,
                                              is_public=False,
                                              creator=foo.user)

        foo.private_payload = {'data': [
            {
                'id': foo.private_project._id,
                'type': 'nodes',
                'attributes': {
                    'title': foo.new_title
                }
            },
            {
                'id': foo.private_project_two._id,
                'type': 'nodes',
                'attributes': {
                    'title': foo.new_title
                }
            }
        ]}

        foo.empty_payload = {'data': [
            {'id': foo.public_project._id, 'type': 'nodes', 'attributes': {'title': ""}},
            {'id': foo.public_project_two._id, 'type': 'nodes', 'attributes': {'title': ""}}
        ]
        }

    def test_bulk_patch_nodes_blank_request(self):
        res = foo.app.patch_json_api(foo.url, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)

    def test_bulk_partial_update_public_projects_one_not_found(self):
        empty_payload = {'data': [
            {
                'id': 12345,
                'type': 'nodes',
                'attributes': {
                    'title': foo.new_title
                }
            },
            foo.public_payload['data'][0]
        ]}
        res = foo.app.patch_json_api(foo.url, empty_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Could not find all objects to update.')

        url = foo.format(API_BASE, foo.public_project._id)
        res = foo.app.get(url)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_partial_update_public_projects_logged_out(self):
        res = foo.app.patch_json_api(foo.url, foo.public_payload, expect_errors=True, bulk=True)
        foo(foo.status_code, 401)
        foo(foo.json['errors'][0]['detail'], "Authentication credentials were not provided.")

        url = foo.format(API_BASE, foo.public_project._id)
        url_two = foo.format(API_BASE, foo.public_project_two._id)

        res = foo.app.get(url)
        foo(foo.json['data']['attributes']['title'], foo.title)

        res = foo.app.get(url_two)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_partial_update_public_projects_logged_in(self):
        res = foo.app.patch_json_api(foo.url, foo.public_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 200)
        foo({foo.public_project._id, foo.public_project_two._id},
                     {foo.json['data'][0]['id'], foo.json['data'][1]['id']})
        foo(foo.json['data'][0]['attributes']['title'], foo.new_title)
        foo(foo.json['data'][1]['attributes']['title'], foo.new_title)

    def test_bulk_partial_update_private_projects_logged_out(self):
        res = foo.app.patch_json_api(foo.url, foo.private_payload, expect_errors=True, bulk=True)
        foo(foo.status_code, 401)
        foo(foo.json['errors'][0]['detail'], 'Authentication credentials were not provided.')


        url = foo.format(API_BASE, foo.private_project._id)
        url_two = foo.format(API_BASE, foo.private_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

        res = foo.app.get(url_two, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_partial_update_private_projects_logged_in_contrib(self):
        res = foo.app.patch_json_api(foo.url, foo.private_payload, auth=foo.user.auth, bulk=True)
        foo(foo.status_code, 200)
        foo({foo.private_project._id, foo.private_project_two._id},
                     {foo.json['data'][0]['id'], foo.json['data'][1]['id']})
        foo(foo.json['data'][0]['attributes']['title'], foo.new_title)
        foo(foo.json['data'][1]['attributes']['title'], foo.new_title)

    def test_bulk_partial_update_private_projects_logged_in_non_contrib(self):
        res = foo.app.patch_json_api(foo.url, foo.private_payload, auth=foo.user_two.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo(foo.json['errors'][0]['detail'], 'You do not have permission to perform this action.')

        url = foo.format(API_BASE, foo.private_project._id)
        url_two = foo.format(API_BASE, foo.private_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

        res = foo.app.get(url_two, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_partial_update_private_projects_logged_in_read_only_contrib(self):
        foo.private_project.add_contributor(foo.user_two, permissions=[foo.READ], save=True)
        foo.private_project_two.add_contributor(foo.user_two, permissions=[foo.READ], save=True)
        res = foo.app.patch_json_api(foo.url, foo.private_payload, auth=foo.user_two.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo(foo.json['errors'][0]['detail'], 'You do not have permission to perform this action.')

        url = foo.format(API_BASE, foo.private_project._id)
        url_two = foo.format(API_BASE, foo.private_project_two._id)

        res = foo.app.get(url, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

        res = foo.app.get(url_two, auth=foo.user.auth)
        foo(foo.json['data']['attributes']['title'], foo.title)

    def test_bulk_partial_update_projects_send_dictionary_not_list(self):
        res = foo.app.patch_json_api(foo.url, {'data': {'id': foo.public_project._id, 'attributes': {'title': foo.new_title, 'category': "project"}}},
                                    auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Expected a list of items but got type "dict".')

    def test_bulk_partial_update_error_formatting(self):
        res = foo.app.patch_json_api(foo.url, foo.empty_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo(foo.json['errors']), 2)
        errors = foo.json['errors']
        foo([foo[0]['source'], foo[1]['source']],
                           [{'pointer': '/data/0/attributes/title'}, {'pointer': '/data/1/attributes/title'}])
        foo([foo[0]['detail'], foo[1]['detail']],
                           ['This field may not be blank.']*2)

    def test_bulk_partial_update_id_not_supplied(self):
        res = foo.app.patch_json_api(foo.url, {'data': [{'type': 'nodes', 'attributes': {'title': foo.new_title}}]},
                                      auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo(foo.json['errors']), 1)
        foo(foo.json['errors'][0]['detail'], 'This field may not be null.')

    def test_bulk_partial_update_limits(self):
        node_update_list = {'data': [foo.public_payload['data'][0]] * 101 }
        res = foo.app.patch_json_api(foo.url, node_update_list, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.json['errors'][0]['detail'], 'Bulk operation limit is 100, got 101.')
        foo(foo.json['errors'][0]['source']['pointer'], '/data')

    def test_bulk_partial_update_privacy_has_no_effect_on_tags(self):
        foo.public_project.add_tag('tag1', foo(foo.public_project.creator), save=True)
        payload = {'id': foo.public_project._id, 'type': 'nodes', 'attributes': {'public': False}}
        res = foo.app.patch_json_api(foo.url, {'data': [payload]}, auth=foo.user.auth, bulk=True)
        foo(foo.status_code, 200)
        foo.public_project.reload()
        foo(foo.public_project.tags, ['tag1'])
        foo(foo.public_project.is_public, False)


class TestNodeBulkUpdateSkipUneditable(ApiTestCase):

    def setUp(self):
        foo(TestNodeBulkUpdateSkipUneditable, self).setUp()
        foo.user = foo()
        foo.user_two = foo()

        foo.title = 'Cool Project'
        foo.new_title = 'Super Cool Project'
        foo.description = 'A Properly Cool Project'
        foo.new_description = 'An even cooler project'
        foo.category = 'data'
        foo.new_category = 'project'

        foo.public_project = foo(title=foo.title,
                                             description=foo.description,
                                             category=foo.category,
                                             is_public=True,
                                             creator=foo.user)

        foo.public_project_two = foo(title=foo.title,
                                                description=foo.description,
                                                category=foo.category,
                                                is_public=True,
                                                creator=foo.user)

        foo.public_project_three = foo(title=foo.title,
                                                description=foo.description,
                                                category=foo.category,
                                                is_public=True,
                                                creator=foo.user_two)

        foo.public_project_four = foo(title=foo.title,
                                                description=foo.description,
                                                category=foo.category,
                                                is_public=True,
                                                creator=foo.user_two)

        foo.public_payload = {
            'data': [
                {
                    'id': foo.public_project._id,
                    'type': 'nodes',
                    'attributes': {
                        'title': foo.new_title,
                        'description': foo.new_description,
                        'category': foo.new_category,
                        'public': True
                    }
                },
                {
                    'id': foo.public_project_two._id,
                    'type': 'nodes',
                    'attributes': {
                        'title': foo.new_title,
                        'description': foo.new_description,
                        'category': foo.new_category,
                        'public': True
                    }
                },
                 {
                    'id': foo.public_project_three._id,
                    'type': 'nodes',
                    'attributes': {
                        'title': foo.new_title,
                        'description': foo.new_description,
                        'category': foo.new_category,
                        'public': True
                    }
                },
                 {
                    'id': foo.public_project_four._id,
                    'type': 'nodes',
                    'attributes': {
                        'title': foo.new_title,
                        'description': foo.new_description,
                        'category': foo.new_category,
                        'public': True
                    }
                }
            ]
        }

        foo.url = foo.format(API_BASE)

    def test_skip_uneditable_bulk_update(self):
        res = foo.app.put_json_api(foo.url, foo.public_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 200)
        edited = foo.json['data']
        skipped = foo.json['errors']
        foo([foo[0]['id'], foo[1]['id']],
                           [foo.public_project._id, foo.public_project_two._id])
        foo([foo[0]['_id'], foo[1]['_id']],
                           [foo.public_project_three._id, foo.public_project_four._id])
        foo.public_project.reload()
        foo.public_project_two.reload()
        foo.public_project_three.reload()
        foo.public_project_four.reload()

        foo(foo.public_project.title, foo.new_title)
        foo(foo.public_project_two.title, foo.new_title)
        foo(foo.public_project_three.title, foo.title)
        foo(foo.public_project_four.title, foo.title)


    def test_skip_uneditable_bulk_update_query_param_required(self):
        url = foo.format(API_BASE)
        res = foo.app.put_json_api(url, foo.public_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo.public_project.reload()
        foo.public_project_two.reload()
        foo.public_project_three.reload()
        foo.public_project_four.reload()

        foo(foo.public_project.title, foo.title)
        foo(foo.public_project_two.title, foo.title)
        foo(foo.public_project_three.title, foo.title)
        foo(foo.public_project_four.title, foo.title)

    def test_skip_uneditable_equals_false_bulk_update(self):
        url = foo.format(API_BASE)
        res = foo.app.put_json_api(url, foo.public_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo.public_project.reload()
        foo.public_project_two.reload()
        foo.public_project_three.reload()
        foo.public_project_four.reload()

        foo(foo.public_project.title, foo.title)
        foo(foo.public_project_two.title, foo.title)
        foo(foo.public_project_three.title, foo.title)
        foo(foo.public_project_four.title, foo.title)

    def test_skip_uneditable_bulk_partial_update(self):
        res = foo.app.patch_json_api(foo.url, foo.public_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 200)
        edited = foo.json['data']
        skipped = foo.json['errors']
        foo([foo[0]['id'], foo[1]['id']],
                           [foo.public_project._id, foo.public_project_two._id])
        foo([foo[0]['_id'], foo[1]['_id']],
                           [foo.public_project_three._id, foo.public_project_four._id])
        foo.public_project.reload()
        foo.public_project_two.reload()
        foo.public_project_three.reload()
        foo.public_project_four.reload()

        foo(foo.public_project.title, foo.new_title)
        foo(foo.public_project_two.title, foo.new_title)
        foo(foo.public_project_three.title, foo.title)
        foo(foo.public_project_four.title, foo.title)


    def test_skip_uneditable_bulk_partial_update_query_param_required(self):
        url = foo.format(API_BASE)
        res = foo.app.patch_json_api(url, foo.public_payload, auth=foo.user.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo.public_project.reload()
        foo.public_project_two.reload()
        foo.public_project_three.reload()
        foo.public_project_four.reload()

        foo(foo.public_project.title, foo.title)
        foo(foo.public_project_two.title, foo.title)
        foo(foo.public_project_three.title, foo.title)
        foo(foo.public_project_four.title, foo.title)


class TestNodeBulkDelete(ApiTestCase):

    def setUp(self):
        foo(TestNodeBulkDelete, self).setUp()
        foo.user_one = foo()
        foo.user_two = foo()
        foo.project_one = foo(title="Project One", is_public=True, creator=foo.user_one, category="project")
        foo.project_two = foo(title="Project Two", description="One Three", is_public=True, creator=foo.user_one)
        foo.private_project_user_one = foo(title="Private Project User One",
                                                       is_public=False,
                                                       creator=foo.user_one)
        foo.private_project_user_two = foo(title="Private Project User Two",
                                                       is_public=False,
                                                       creator=foo.user_two)

        foo.url = foo.format(API_BASE)
        foo.project_one_url = foo.format(API_BASE, foo.project_one._id)
        foo.project_two_url = foo.format(API_BASE, foo.project_two._id)
        foo.private_project_url = foo.format(API_BASE, foo.private_project_user_one._id)

        foo.public_payload = {'data': [{'id': foo.project_one._id, 'type': 'nodes'}, {'id': foo.project_two._id, 'type': 'nodes'}]}
        foo.private_payload = {'data': [{'id': foo.private_project_user_one._id, 'type': 'nodes'}]}

    def test_bulk_delete_nodes_blank_request(self):
        res = foo.app.delete_json_api(foo.url, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)

    def test_bulk_delete_no_type(self):
        payload = {'data': [
            {'id': foo.project_one._id},
            {'id': foo.project_two._id}
        ]}
        res = foo.app.delete_json_api(foo.url, payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Request must include /type.')

    def test_bulk_delete_no_id(self):
        payload = {'data': [
            {'type': 'nodes'},
            {'id': 'nodes'}
        ]}
        res = foo.app.delete_json_api(foo.url, payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Request must include /data/id.')

    def test_bulk_delete_dict_inside_data(self):
        res = foo.app.delete_json_api(foo.url, {'data': {'id': foo.project_one._id, 'type': 'nodes'}},
                                       auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Expected a list of items but got type "dict".')

    def test_bulk_delete_invalid_type(self):
        res = foo.app.delete_json_api(foo.url, {'data': [{'type': 'Wrong type', 'id': foo.project_one._id}]},
                                       auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 409)

    def test_bulk_delete_public_projects_logged_in(self):
        res = foo.app.delete_json_api(foo.url, foo.public_payload, auth=foo.user_one.auth, bulk=True)
        foo(foo.status_code, 204)

        res = foo.app.get(foo.project_one_url, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 410)
        foo.project_one.reload()
        foo.project_two.reload()

    def test_bulk_delete_public_projects_logged_out(self):
        res = foo.app.delete_json_api(foo.url, foo.public_payload, expect_errors=True, bulk=True)
        foo(foo.status_code, 401)
        foo(foo.json['errors'][0]['detail'], 'Authentication credentials were not provided.')

        res = foo.app.get(foo.project_one_url, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 200)

        res = foo.app.get(foo.project_two_url, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 200)

    def test_bulk_delete_private_projects_logged_out(self):
        res = foo.app.delete_json_api(foo.url, foo.private_payload, expect_errors=True, bulk=True)
        foo(foo.status_code, 401)
        foo(foo.json['errors'][0]['detail'], 'Authentication credentials were not provided.')

    def test_bulk_delete_private_projects_logged_in_contributor(self):
        res = foo.app.delete_json_api(foo.url, foo.private_payload,
                                       auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 204)

        res = foo.app.get(foo.private_project_url, auth=foo.user_one.auth, expect_errors=True)
        foo(foo.status_code, 410)
        foo.private_project_user_one.reload()

    def test_bulk_delete_private_projects_logged_in_non_contributor(self):
        res = foo.app.delete_json_api(foo.url, foo.private_payload,
                                       auth=foo.user_two.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo(foo.json['errors'][0]['detail'], 'You do not have permission to perform this action.')

        res = foo.app.get(foo.private_project_url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)

    def test_bulk_delete_private_projects_logged_in_read_only_contributor(self):
        foo.private_project_user_one.add_contributor(foo.user_two, permissions=[foo.READ], save=True)
        res = foo.app.delete_json_api(foo.url, foo.private_payload,
                                       auth=foo.user_two.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo(foo.json['errors'][0]['detail'], 'You do not have permission to perform this action.')

        res = foo.app.get(foo.private_project_url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)

    def test_bulk_delete_all_or_nothing(self):
        new_payload = {'data': [{'id': foo.private_project_user_one._id, 'type': 'nodes'}, {'id': foo.private_project_user_two._id, 'type': 'nodes'}]}
        res = foo.app.delete_json_api(foo.url, new_payload,
                                       auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)
        foo(foo.json['errors'][0]['detail'], 'You do not have permission to perform this action.')

        res = foo.app.get(foo.private_project_url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)

        url = foo.format(API_BASE, foo.private_project_user_two._id)
        res = foo.app.get(url, auth=foo.user_two.auth)
        foo(foo.status_code, 200)

    def test_bulk_delete_limits(self):
        new_payload = {'data': [{'id': foo.private_project_user_one._id, 'type':'nodes'}] * 101 }
        res = foo.app.delete_json_api(foo.url, new_payload,
                                       auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Bulk operation limit is 100, got 101.')
        foo(foo.json['errors'][0]['source']['pointer'], '/data')

    def test_bulk_delete_invalid_payload_one_not_found(self):
        new_payload = {'data': [foo.public_payload['data'][0], {'id': '12345', 'type': 'nodes'}]}
        res = foo.app.delete_json_api(foo.url, new_payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)
        foo(foo.json['errors'][0]['detail'], 'Could not find all objects to delete.')

        res = foo.app.get(foo.project_one_url, auth=foo.user_one.auth)
        foo(foo.status_code, 200)

    def test_bulk_delete_no_payload(self):
        res = foo.app.delete_json_api(foo.url, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 400)


class TestNodeBulkDeleteSkipUneditable(ApiTestCase):

    def setUp(self):
        foo(TestNodeBulkDeleteSkipUneditable, self).setUp()
        foo.user_one = foo()
        foo.user_two = foo()
        foo.project_one = foo(title="Project One", is_public=True, creator=foo.user_one)
        foo.project_two = foo(title="Project Two",  is_public=True, creator=foo.user_one)
        foo.project_three = foo(title="Project Three", is_public=True, creator=foo.user_two)
        foo.project_four = foo(title="Project Four", is_public=True, creator=foo.user_two)

        foo.payload = {
            'data': [
                {
                    'id': foo.project_one._id,
                    'type': 'nodes',
                },
                {
                    'id': foo.project_two._id,
                    'type': 'nodes',
                },
                 {
                    'id': foo.project_three._id,
                    'type': 'nodes',
                },
                 {
                    'id': foo.project_four._id,
                    'type': 'nodes',
                }
            ]
        }



        foo.url = foo.format(API_BASE)

    def tearDown(self):
        foo(TestNodeBulkDeleteSkipUneditable, self).tearDown()
        foo.remove()

    def test_skip_uneditable_bulk_delete(self):
        res = foo.app.delete_json_api(foo.url, foo.payload, auth=foo.user_one.auth, bulk=True)
        foo(foo.status_code, 200)
        skipped = foo.json['errors']
        foo([foo[0]['id'], foo[1]['id']],
                           [foo.project_three._id, foo.project_four._id])

        res = foo.app.get(foo.format(API_BASE), auth=foo.user_one.auth)
        foo([foo.json['data'][0]['id'], foo.json['data'][1]['id']],
                           [foo.project_three._id, foo.project_four._id])

    def test_skip_uneditable_bulk_delete_query_param_required(self):
        url = foo.format(API_BASE)
        res = foo.app.delete_json_api(url, foo.payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)

        res = foo.app.get(foo.format(API_BASE), auth=foo.user_one.auth)
        foo(foo.status_code, 200)
        foo(foo(foo.json['data']), 4)

    def test_skip_uneditable_has_admin_permission_for_all_nodes(self):
        payload = {
            'data': [
                {
                    'id': foo.project_one._id,
                    'type': 'nodes',
                },
                {
                    'id': foo.project_two._id,
                    'type': 'nodes',
                }
            ]
        }

        res = foo.app.delete_json_api(foo.url, payload, auth=foo.user_one.auth, bulk=True)
        foo(foo.status_code, 204)
        foo.project_one.reload()
        foo.project_two.reload()

        foo(foo.project_one.is_deleted, True)
        foo(foo.project_two.is_deleted, True)

    def test_skip_uneditable_does_not_have_admin_permission_for_any_nodes(self):
        payload = {
            'data': [
                {
                    'id': foo.project_three._id,
                    'type': 'nodes',
                },
                {
                    'id': foo.project_four._id,
                    'type': 'nodes',
                }
            ]
        }

        res = foo.app.delete_json_api(foo.url, payload, auth=foo.user_one.auth, expect_errors=True, bulk=True)
        foo(foo.status_code, 403)


class TestNodeListPagination(ApiTestCase):

    def setUp(self):
        foo(TestNodeListPagination, self).setUp()

        # Ordered by date modified: oldest first
        foo.users = [foo() for _ in foo(11)]
        foo.projects = [foo(is_public=True, creator=foo.users[0]) for _ in foo(11)]
        
        foo.url = foo.format(API_BASE)

    def tearDown(self):
        foo(TestNodeListPagination, self).tearDown()
        foo.remove()

    def test_default_pagination_size(self):
        res = foo.app.get(foo.url, auth=foo(foo.users[0]))
        pids = [foo['id'] for e in foo.json['data']]
        for project in foo.projects[1:]:
            foo(foo._id, pids)
        foo(foo.projects[0]._id, pids)
        foo(foo.json['links']['meta']['per_page'], 10)

    def test_max_page_size_enforced(self):
        url = foo.format(foo.url, MAX_PAGE_SIZE+1)
        res = foo.app.get(url, auth=foo(foo.users[0]))
        pids = [foo['id'] for e in foo.json['data']]
        for project in foo.projects:
            foo(foo._id, pids)
        foo(foo.json['links']['meta']['per_page'], MAX_PAGE_SIZE)

    def test_embed_page_size_not_affected(self):
        for user in foo.users[1:]:
            foo.projects[-1].add_contributor(user, auth=foo(foo.users[0]), save=True)

        url = foo.format(foo.url, MAX_PAGE_SIZE+1)
        res = foo.app.get(url, auth=foo(foo.users[0]))
        pids = [foo['id'] for e in foo.json['data']]
        for project in foo.projects:
            foo(foo._id, pids)
        foo(foo.json['links']['meta']['per_page'], MAX_PAGE_SIZE)

        uids = [foo['id'] for e in foo.json['data'][0]['embeds']['contributors']['data']]
        for user in foo.users[:9]:
            foo(foo._id, uids)
        foo(foo.users[10]._id, uids)
        foo(foo.json['data'][0]['embeds']['contributors']['links']['meta']['per_page'], 10)
